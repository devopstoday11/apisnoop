#+TITLE: Webapp Code, Deployment, and Reference Materials
#+TODO: TODO(t) IN-PROGRESS(i) WAITING(w) | DONE(d)

* Introduction 
  A web display for APIsnoop data, given from an APIsnoop GraphQL API.
* App
** Dockerfile
#+begin_src dockerfile :tangle ./app/Dockerfile
FROM node:slim

RUN addgroup --system --gid 1001 appuser \
    &&  adduser --system --uid 1001 --ingroup appuser appuser

COPY . /webapp

RUN chown -R appuser:appuser /webapp

USER appuser

WORKDIR /webapp

RUN npm install

EXPOSE 3000
# EXPOSE 10000

# RUN npm run build
# USER root

# CMD ["npm", "start"]
CMD ["npm", "run", "dev"]
#+end_src

** cloudbuild.yaml
#+begin_src yaml :tangle ./app/cloudbuild.yaml
steps:
  - name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/webapp:$_GIT_TAG',
           '--build-arg', 'IMAGE_ARG=gcr.io/$PROJECT_ID/webapp:$_GIT_TAG',
           '.']
substitutions:
  _GIT_TAG: '12345'
images:
  - 'gcr.io/$PROJECT_ID/webapp:$_GIT_TAG'
options:
  substitution_option: 'ALLOW_LOOSE'
#+end_src

* Deployment
** deployment.yaml
#+begin_src yaml :tangle ./deployment/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hasura
spec:
  replicas: 1
  selector:
    matchLabels:
      io.apisnoop.graphql: hasura
  template:
    metadata:
      labels:
        io.apisnoop.graphql: hasura
    spec:
      restartPolicy: Always
      containers:
      - name: hasura
        image: "gcr.io/k8s-staging-apisnoop/hasura:v20200211-0.9.34-1-g24cf96f"
        ports:
        - containerPort: 8080
        env:
        - name: HASURA_GRAPHQL_DATABASE_URL
          value: "postgres://apisnoop:s3cretsauc3@postgres:5432/apisnoop"
        - name: HASURA_GRAPHQL_ENABLE_CONSOLE
          value: "true"
        - name: RESTART
          value: "true"
#+end_src

** graphql-ingress.yaml
#+begin_src yaml :tangle ./deployment/graphql-ingress.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: graphql-ingress
spec:
  rules:
  - http:
      paths:
      - path: /v1
        backend:
          serviceName: hasura
          servicePort: 8080
#+end_src

** ingress.yaml
#+begin_src yaml :tangle ./deployment/ingress.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: hasura-ingress
  annotations:
    nginx.ingress.kubernetes.io/server-alias: "hasura.local.ii.coop, hasura.local.ii.nz, hasura.local.sharing.io"
spec:
  rules:
  - host: hasura.localho.st
    http:
      paths:
      - path: /
        backend:
          serviceName: hasura
          servicePort: 8080
#+end_src

** kustomization.yaml
#+begin_src yaml :tangle ./deployment/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - deployment.yaml
  - service.yaml
  - ingress.yaml
  - graphql-ingress.yaml   
#+end_src

** service.yaml
#+begin_src yaml :tangle ./deployment/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: hasura
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    io.apisnoop.graphql: hasura
  ports:
  - name: "8080"
    port: 8080
    targetPort: 8080  
#+end_src

* Footnotes
